<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video to MP3 Converter — ThrasherApps</title>
  <meta name="description" content="Convert a local video file to MP3 directly in your browser. No uploads, no servers — all on-device." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="assets/site.css">
  <style>
    /* Page-specific small tweaks */
    #videoFile {
      width: 100%;
      margin-top: 4px;
    }
    #status {
      min-height: 1.2em;
    }
  </style>
</head>
<body>

  <!-- Sticky Header / Nav (same as index.html) -->
  <header class="site-header">
    <div class="container nav">
      <a class="brand" href="/">ThrasherApps</a>
      <nav class="nav-links">
        <a href="/">Home</a>
        <a href="apps.html">Apps</a>
        <a href="ai.html">AI Solutions</a>
        <a href="grc-lab.html">GRC Lab</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <!-- Main Section -->
  <section class="section">
    <div class="container">
      <h1 class="h2">Video to MP3 Converter</h1>
      <p class="lead">
        Convert any video file on your device into an MP3 you can play offline on iPhone or Android.
        Everything runs in your browser—nothing is uploaded to my server.
      </p>

      <div class="card mt-3">
        <form id="convertForm">
          <label for="videoFile">Choose a video file</label>
          <input type="file" id="videoFile" accept="video/*" required />
          <button class="btn mt-2" id="convertBtn" type="submit">
            Convert to MP3
          </button>
        </form>

        <p id="status" class="small mt-2"></p>

        <p class="small mt-2">
          Note: The first time you use this, the converter has to download in the background (a one-time
          download). On a slow connection, that can take a while. After that, conversions are much faster.
        </p>
      </div>
    </div>
  </section>

  <!-- CTA Band -->
  <section class="section cta-band">
    <div class="container wrap">
      <p class="lead">Need a custom tool like this for your team or business?</p>
      <p><a class="btn" href="contact.html">Start a Project</a></p>
    </div>
  </section>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container">
      <div>© 2025 ThrasherApps.com — Built by Chris Thrasher</div>
      <div class="mt-2">
        <a href="mailto:cbthrasher2020@gmail.com">Email</a> ·
        <a href="privacy.html">Privacy</a> ·
        <a target="_blank" href="https://christhrasher.wordpress.com/2025/08/02/trialmate-end-user-license-agreement-eula/">EULA</a>
      </div>
    </div>
  </footer>

  <!-- Tiny scroll-reveal helper + nav highlighter -->
  <script>
    (function () {
      const els = document.querySelectorAll('.reveal');
      const onObs = entries => entries.forEach(e=>{
        if (e.isIntersecting){ e.target.classList.add('in'); obs.unobserve(e.target); }
      });
      const obs = ('IntersectionObserver' in window) ? new IntersectionObserver(onObs, {threshold: 0.08}) : null;
      els.forEach(el => { if (obs) obs.observe(el); else el.classList.add('in'); });

      // highlight current nav link
      const here = location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('.nav-links a').forEach(a=>{
        const target = a.getAttribute('href');
        if ((here === 'index.html' && target === '/') || here === target) a.classList.add('active');
      });
    })();
  </script>

  <!-- FFmpeg WASM via global script, loaded once -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js"></script>
  <script>
    const form = document.getElementById('convertForm');
    const statusEl = document.getElementById('status');
    const convertBtn = document.getElementById('convertBtn');
    const fileInput = document.getElementById('videoFile');

    let ffmpeg = null;
    let ffmpegLoaded = false;
    let ffmpegLoading = false;

    function setStatus(text) {
      statusEl.textContent = text;
    }

    async function ensureFFmpegLoaded() {
      if (ffmpegLoaded) return;

      if (!ffmpeg) {
        // `FFmpeg` global is provided by the script above
        const { createFFmpeg, fetchFile } = FFmpeg;
        ffmpeg = createFFmpeg({ log: true });
        window._ffmpegFetchFile = fetchFile; // stash for later
      }

      if (!ffmpegLoading) {
        ffmpegLoading = true;
        setStatus('Downloading converter (one-time). This can take a while on slower connections…');
        try {
          await ffmpeg.load();
          ffmpegLoaded = true;
          setStatus('Converter ready. Starting conversion…');
        } catch (err) {
          console.error(err);
          setStatus('Failed to download the converter. Please refresh the page and try again.');
          throw err;
        }
      } else {
        setStatus('Still downloading converter…');
        await ffmpeg.load();
        ffmpegLoaded = true;
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const file = fileInput.files[0];
      if (!file) {
        setStatus('Please choose a video file first.');
        return;
      }

      convertBtn.disabled = true;
      const originalBtnText = convertBtn.textContent;
      convertBtn.textContent = 'Converting…';

      try {
        // 1) Ensure FFmpeg is loaded (this is the “slow first time” part)
        await ensureFFmpegLoaded();

        const fetchFile = window._ffmpegFetchFile;

        // 2) Write the input file into ffmpeg’s virtual FS
        ffmpeg.FS('writeFile', 'input', await fetchFile(file));

        // 3) Run FFmpeg to extract audio as MP3
        setStatus('Converting to MP3…');
        await ffmpeg.run(
          '-i', 'input',
          '-vn',
          '-acodec', 'libmp3lame',
          '-b:a', '192k',
          'output.mp3'
        );

        // 4) Read the result and trigger download
        const data = ffmpeg.FS('readFile', 'output.mp3');
        const blob = new Blob([data.buffer], { type: 'audio/mpeg' });
        const originalName = file.name.replace(/\.[^/.]+$/, '') || 'audio';

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = originalName + '.mp3';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setStatus('Done! Check your downloads for the new MP3 file.');

        // 5) Clean up in FFmpeg’s virtual FS
        ffmpeg.FS('unlink', 'input');
        ffmpeg.FS('unlink', 'output.mp3');
      } catch (err) {
        // Error is already logged & status set in ensureFFmpegLoaded if it failed there
        console.error(err);
        if (!statusEl.textContent) {
          setStatus('Conversion failed. Try a smaller or different video file, or refresh the page.');
        }
      } finally {
        convertBtn.disabled = false;
        convertBtn.textContent = originalBtnText;
      }
    });
  </script>
</body>
</html>
